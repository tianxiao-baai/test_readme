name: Update README from HuggingFace

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # 每 6 小时更新一次

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch HuggingFace Models
        id: fetch
        run: |
          ORG="FlagRelease"
          API="https://huggingface.co/api/models?author=$ORG&limit=200"

          # 需要去掉的后缀（大小写不敏感）
          REMOVE_SUFFIXES=("-FlagOS" "-Nvidia" "-Metax" "-Iluvatar" "-Cambricon" "-Kunlunxin")

          echo "Fetching models for org: $ORG"
          RESP=$(curl -s "$API")

          echo "$RESP" | jq 'if type=="array" then true else false end' || exit 1

          echo "$RESP" | jq -r '.[] | [.id, .cardData.description] | @tsv' > raw.tsv

          declare -A MODEL_MAP
          declare -A DESC_MAP

          while IFS=$'\t' read -r ID DESC; do
            ORIG_ID="$ID"

            # 1. 取最后一个 /
            BASE="${ID##*/}"

            CLEAN="$BASE"

            # 用于大小写不敏感匹配
            CLEAN_LOWER="${CLEAN,,}"

            # 2. 去掉后缀（大小写不敏感）
            for suf in "${REMOVE_SUFFIXES[@]}"; do
              suf_lower="${suf,,}"
              if [[ "$CLEAN_LOWER" == *"$suf_lower" ]]; then
                # 删掉干净的大小写版本
                suf_len=${#suf}
                CLEAN="${CLEAN:0:${#CLEAN}-${suf_len}}"
                break
              fi
            done

            # 3. 保存合并数据
            if [[ -z "${MODEL_MAP[$CLEAN]}" ]]; then
              MODEL_MAP[$CLEAN]="$ORIG_ID"
              DESC_MAP[$CLEAN]="${DESC:-无描述}"
            else
              MODEL_MAP[$CLEAN]="${MODEL_MAP[$CLEAN]}<br>$ORIG_ID"
            fi
          done < raw.tsv

          # 生成 markdown
          echo '| Model Name | 原始模型 | 描述 |' > models.md
          echo '|------------|----------|------|' >> models.md

          for key in "${!MODEL_MAP[@]}"; do
            echo "| ${key} | ${MODEL_MAP[$key]} | ${DESC_MAP[$key]} |" >> models.md
          done

          CONTENT=$(cat models.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          # 写入临时表格文件
          echo "${{ steps.fetch.outputs.content }}" > models_table.md

          # 使用 Perl 跨行替换 START/END 区域
          perl -CS -0777 -i -pe '
            BEGIN {
              local $/;   # slurp whole file
              open my $fh, "<:utf8", "models_table.md" or die $!;
              $table = <$fh>;
              close $fh;
            }
            s|<!-- START:models -->.*?<!-- END:models -->|<!-- START:models -->\n$table\n<!-- END:models -->|s
          ' README.md


      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "update HuggingFace models list" || echo "No changes"
          git push
